# 后端服务在本地运行的指南

本文档介绍如何不使用 Docker 容器，直接在本地运行后端服务。

## 目录结构

```
backend/
├── run.sh           # 在本地直接启动后端服务的过渡性脚本
├── src/            # 生产代码目录
│   └── main.py     # 主程序入口
└── venv_py312/     # Python 虚拟环境
```

## run.sh 脚本说明

`run.sh` 是一个过渡性的入口脚本，用于在本地直接启动后端服务而不使用 Docker 容器。

**注意**：这是一个过渡性脚本，为了保持向后兼容性而存在。建议开发时直接使用 `src/main.py`。

### 脚本功能

- 自动检测和激活虚拟环境
- 参数验证（环境类型、IP地址、端口号）
- 端口清理（清理 8000-9999 端口范围的进程）
- 环境变量设置

### 使用方法

```bash
./run.sh <环境类型> <IP地址> <端口号>
```

#### 参数说明

- **环境类型**：可选值：`unit`, `func`, `uat`, `prod`
- **IP地址**：IPv4 地址格式，如 `127.0.0.1`
- **端口号**：1-65535 之间的数字

#### 使用示例

```bash
# 单元测试环境
./run.sh unit 127.0.0.1 8080

# 功能测试环境
./run.sh func 127.0.0.1 8080

# UAT 测试环境
./run.sh uat 127.0.0.1 8080

# 生产环境
./run.sh prod 127.0.0.1 8080
```

### 环境要求

1. **Python 虚拟环境**：脚本会自动检测并激活 `venv_py312` 虚拟环境
2. **依赖安装**：确保虚拟环境中已安装所有必需依赖
3. **端口权限**：确保指定的端口未被其他进程占用

### 错误处理

脚本包含以下验证和错误处理：

- **参数数量检查**：必须提供 3 个参数
- **环境类型验证**：必须是 unit, func, uat, prod 之一
- **IP地址格式验证**：简单的 IPv4 格式检查
- **端口号范围验证**：必须在 1-65535 范围内
- **虚拟环境检查**：确保在虚拟环境中运行

### 环境变量

脚本会设置以下环境变量：

- `ENV_TYPE`：环境类型（unit/func/uat/prod）
- `IP`：IP地址
- `PORT`：端口号

### 端口清理

脚本启动前会自动执行端口清理：

- 调用 `scripts/killport.sh` 脚本
- 清理 8000-9999 端口范围的进程
- 如果脚本不存在，会显示警告但继续执行

## 直接使用主程序

推荐的开发方式是直接使用主程序：

```bash
# 激活虚拟环境
source venv_py312/bin/activate

# 运行主程序
python src/main.py <IP地址> <端口号>
```

## 故障排除

### 常见问题

1. **虚拟环境未找到**
   ```
   [ERROR] 未检测到虚拟环境，请先激活虚拟环境或安装依赖
   ```
   解决方案：创建虚拟环境或手动激活

2. **端口被占用**
   ```
   [WARNING] 未找到 scripts/killport.sh，跳过端口清理
   ```
   解决方案：手动停止占用端口的进程

3. **参数错误**
   ```
   [ERROR] 请提供所有必需参数：环境类型 IP地址 端口号
   ```
   解决方案：提供正确的参数数量和格式

### 调试模式

如果需要调试，可以直接运行主程序：

```bash
source venv_py312/bin/activate
python src/main.py 127.0.0.1 8080
```

## 最佳实践

1. **开发环境**：使用 `func` 环境类型
2. **测试环境**：使用 `uat` 环境类型
3. **生产部署**：使用 `prod` 环境类型
4. **单元测试**：使用 `unit` 环境类型
5. **端口选择**：开发时建议使用 8080 端口，避免与其他服务冲突