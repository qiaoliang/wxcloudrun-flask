# 社区用户删除逻辑设计文档

## 概述

本文档描述社区用户删除功能的逻辑设计。根据需求变更，删除逻辑需要根据社区类型执行不同的操作。

## 需求说明

### 原始需求
在管理员的社区列表页面的社区成员列表时，点击"删除"按钮时：
1. 如果当前社区是"普通"社区，则需要将该用户"移动"到安卡大家庭的默认社区中
2. 如果当前社区是"安卡大家庭"，那么就将其移动到"黑屋"社区
3. 如果当前社区是"黑屋"社区，就将该用户的所有信息全部物理删除

### 变更后的需求
1. 如果当前社区是"普通"社区，则需要将该用户"移动"到安卡大家庭的默认社区中
2. 如果当前社区是"安卡大家庭"，那么就将其移动到"黑屋"社区
3. **如果当前社区是"黑屋"社区，不能删除用户**

## 当前实现分析

### 现有代码位置
1. **API 视图层**: `src/wxcloudrun/views/community.py` - `remove_community_user()` 函数
2. **业务服务层**: `src/wxcloudrun/community_service.py` - `CommunityService.remove_user_from_community()` 方法

### 当前逻辑
从代码分析，当前实现已经部分满足需求：
1. **普通社区 → 安卡大家庭**: 已实现
   - 检查用户是否还属于其他普通社区
   - 如果不属于任何其他普通社区，移入"安卡大家庭"
2. **安卡大家庭 → 黑屋社区**: 已实现
   - 直接从"安卡大家庭"移除的用户移入"黑屋"
3. **黑屋社区删除**: 当前可能允许删除，需要添加限制

## 设计目标

### 核心原则
1. **DRY 原则**: API 视图层调用业务服务层的方法，避免逻辑重复
2. **一致性**: 所有删除逻辑集中在业务服务层
3. **安全性**: 适当的权限验证和错误处理
4. **可维护性**: 清晰的代码结构和文档

### 功能要求
1. 根据社区类型执行不同的删除/移动操作
2. 黑屋社区不能删除用户
3. 返回明确的操作结果（移动到了哪个社区或错误信息）

## 详细设计

### 1. 业务服务层修改

#### `CommunityService.remove_user_from_community(community_id, user_id)`
**输入**:
- `community_id`: 社区ID
- `user_id`: 用户ID

**逻辑流程**:
```python
def remove_user_from_community(community_id, user_id):
    # 1. 验证社区和用户存在
    # 2. 获取社区信息（包括社区类型）
    # 3. 根据社区类型执行不同操作：
    
    if community.name == "黑屋":
        # 黑屋社区：不能删除用户
        raise ValueError("不能从黑屋社区删除用户")
    
    elif community.name == "安卡大家庭":
        # 安卡大家庭 → 黑屋社区
        # 检查是否已在黑屋
        # 如果不在，添加到黑屋社区
        moved_to = "黑屋"
    
    else:
        # 普通社区 → 安卡大家庭
        # 检查用户是否还属于其他普通社区
        # 如果不属于任何其他普通社区，添加到安卡大家庭
        moved_to = "安卡大家庭"
    
    # 4. 删除原社区的成员关系
    # 5. 返回操作结果
    return {"moved_to": moved_to}
```

### 2. API 视图层修改

#### `remove_community_user()` 函数
**职责**:
1. 验证请求参数和用户权限
2. 调用业务服务层的方法
3. 处理异常并返回适当的HTTP响应
4. 记录操作日志

**响应格式**:
```json
{
    "code": 1,
    "msg": "success",
    "data": {
        "moved_to": "安卡大家庭"  // 或 "黑屋" 或 null（如果只是移除）
    }
}
```

**错误响应**:
```json
{
    "code": 0,
    "msg": "不能从黑屋社区删除用户",
    "data": {}
}
```

## 数据库事务处理

### 事务边界
所有数据库操作应该在单个事务中执行：
1. 查询社区和用户信息
2. 根据社区类型执行相应操作
3. 提交或回滚事务

### 错误处理
1. **数据库错误**: 回滚事务，返回服务器错误
2. **业务逻辑错误**: 回滚事务，返回具体的错误信息
3. **权限错误**: 返回权限不足错误

## 权限验证

### 允许执行删除操作的角色
1. **超级管理员** (role=4): 可以删除任何社区的用户
2. **社区主管** (role=3): 只能删除自己管理的社区的用户
3. **社区专员** (role=2): 只能删除自己管理的社区的用户

### 权限检查逻辑
1. 超级管理员跳过社区权限检查
2. 其他角色需要检查是否是社区工作人员

## 测试策略

### 单元测试
1. 测试三种社区类型的删除逻辑
2. 测试权限验证
3. 测试错误处理

### 集成测试
1. 完整的用户删除流程
2. 数据库事务测试
3. 并发操作测试

### E2E测试
1. 管理员界面操作测试
2. API 端点测试

## 实施计划

### 阶段1: 分析当前实现
- [ ] 详细分析现有的删除逻辑
- [ ] 确认当前是否允许从黑屋社区删除用户

### 阶段2: 修改业务服务层
- [ ] 添加黑屋社区不能删除的限制
- [ ] 确保逻辑正确性
- [ ] 添加适当的错误消息

### 阶段3: 更新API视图层
- [ ] 确保视图层调用服务层方法
- [ ] 更新错误响应处理
- [ ] 添加操作日志

### 阶段4: 测试
- [ ] 编写单元测试
- [ ] 运行现有测试确保不破坏现有功能
- [ ] 手动测试三种场景

## 风险与缓解

### 风险1: 破坏现有功能
**缓解**: 充分测试，确保修改不影响现有的删除逻辑

### 风险2: 权限漏洞
**缓解**: 仔细检查权限验证逻辑，确保只有授权用户能执行删除

### 风险3: 数据不一致
**缓解**: 使用数据库事务，确保操作的原子性

## 附录

### 相关文件
1. `src/wxcloudrun/views/community.py` - API视图层
2. `src/wxcloudrun/community_service.py` - 业务服务层
3. `src/database/models.py` - 数据模型定义

### 相关常量
1. `DEFUALT_COMMUNITY_NAME = '安卡大家庭'`
2. `DEFAULT_BLACK_ROOM_NAME = '黑屋'`
3. `BLACKHOUSE_COMMUNITY_NAME = '黑屋'`

---

**文档版本**: v1.0  
**创建日期**: 2025-12-18  
**最后更新**: 2025-12-18  
**维护者**: SafeGuard 开发团队