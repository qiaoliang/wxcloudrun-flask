# æ‰‹æœºå·ç™»å½•APIå¿«ç…§å¯¹æ¯”é›†æˆæµ‹è¯•è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä¸º `/api/auth/login_phone` ç«¯ç‚¹è®¾è®¡çš„åŸºäºå¿«ç…§å¯¹æ¯”çš„è‡ªåŠ¨åŒ–é›†æˆæµ‹è¯•ï¼Œä¸“æ³¨äºéªŒè¯APIè¿”å›æ•°æ®ä¸æ•°æ®åº“æ•°æ®çš„å®Œæ•´ä¸€è‡´æ€§ã€‚

## è®¾è®¡ç›®æ ‡

### ä¸»è¦ç›®æ ‡
- **æ•°æ®ä¸€è‡´æ€§éªŒè¯**ï¼šç¡®ä¿APIè¿”å›çš„æ¯ä¸ªå­—æ®µéƒ½ä¸æ•°æ®åº“ä¸­çš„åŸå§‹æ•°æ®ä¿æŒä¸€è‡´
- **å¿«ç…§å¯¹æ¯”æœºåˆ¶**ï¼šä½¿ç”¨é¢„å®šä¹‰çš„"é»„é‡‘å¿«ç…§"ä¸å®é™…APIå“åº”è¿›è¡Œæ·±åº¦å¯¹æ¯”
- **å›å½’æµ‹è¯•æ•ˆç‡**ï¼šé€šè¿‡å¿«ç…§æœºåˆ¶å®ç°å¿«é€Ÿã€å¯é çš„å›å½’æµ‹è¯•
- **å…¨é¢è¦†ç›–**ï¼šæ¶µç›–æˆåŠŸåœºæ™¯ã€é”™è¯¯åœºæ™¯ã€æ€§èƒ½ä¸€è‡´æ€§ç­‰å¤šä¸ªç»´åº¦

### æµ‹è¯•èŒƒå›´
- âœ… **æˆåŠŸç™»å½•åœºæ™¯**ï¼šéªŒè¯æ­£å¸¸ç™»å½•æµç¨‹çš„æ•°æ®ä¸€è‡´æ€§
- âœ… **é”™è¯¯å¤„ç†åœºæ™¯**ï¼šéªŒè¯å„ç§é”™è¯¯æƒ…å†µä¸‹çš„å“åº”æ•°æ®æ ¼å¼
- âœ… **æ€§èƒ½ä¸€è‡´æ€§**ï¼šéªŒè¯å¤šæ¬¡è¯·æ±‚çš„å“åº”ç¨³å®šæ€§
- âœ… **æ•°æ®ç±»å‹éªŒè¯**ï¼šç¡®ä¿è¿”å›æ•°æ®ç±»å‹æ­£ç¡®
- âœ… **ä¸šåŠ¡é€»è¾‘éªŒè¯**ï¼šç¡®ä¿å…³é”®ä¸šåŠ¡å­—æ®µæ­£ç¡®æ˜ å°„

## æ¶æ„è®¾è®¡

### æµ‹è¯•æ¶æ„
```
TestAuthLoginPhoneSnapshot
â”œâ”€â”€ setup_class()          # æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–
â”œâ”€â”€ teardown_class()       # æµ‹è¯•ç¯å¢ƒæ¸…ç†
â”œâ”€â”€ _create_test_data()     # åˆ›å»ºæ ‡å‡†åŒ–æµ‹è¯•æ•°æ®
â”œâ”€â”€ test_login_phone_snapshot_data_integrity()     # æ ¸å¿ƒå¿«ç…§å¯¹æ¯”æµ‹è¯•
â”œâ”€â”€ test_login_phone_error_cases_data_consistency()  # é”™è¯¯åœºæ™¯æµ‹è¯•
â”œâ”€â”€ test_login_phone_performance_consistency()      # æ€§èƒ½ä¸€è‡´æ€§æµ‹è¯•
â”œâ”€â”€ test_login_phone_data_type_consistency()        # æ•°æ®ç±»å‹éªŒè¯
â””â”€â”€ test_login_phone_business_logic_consistency()    # ä¸šåŠ¡é€»è¾‘éªŒè¯
```

### å¿«ç…§å¯¹æ¯”æœºåˆ¶

#### é¢„æœŸå¿«ç…§ç»“æ„
```python
expected_snapshot = {
    'user_id': int,              # ç”¨æˆ·ID
    'wechat_openid': str,        # å¾®ä¿¡OpenID
    'phone_number': str,         # æ‰‹æœºå·
    'nickname': str,             # æ˜µç§°
    'name': str,                 # çœŸå®å§“å
    'avatar_url': str,           # å¤´åƒURLï¼ˆå¯ä¸ºnullï¼‰
    'role': str,                 # è§’è‰²åç§°ï¼ˆæ˜ å°„åï¼‰
    'community_id': int,         # ç¤¾åŒºID
    'community_name': str,       # ç¤¾åŒºåç§°
    'login_type': str            # ç™»å½•ç±»å‹ï¼ˆnew_user/existing_userï¼‰
}
```

#### åŠ¨æ€å­—æ®µéªŒè¯
- `token`: JWTè®¿é—®ä»¤ç‰Œ
- `refresh_token`: åˆ·æ–°ä»¤ç‰Œ

## æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### 1. æ•°æ®å®Œæ•´æ€§æµ‹è¯• (`test_login_phone_snapshot_data_integrity`)

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯APIè¿”å›çš„æ‰€æœ‰å­—æ®µä¸é¢„æœŸå¿«ç…§å®Œå…¨åŒ¹é…

**æµ‹è¯•æ­¥éª¤**ï¼š
1. åˆ›å»ºæ ‡å‡†æµ‹è¯•ç”¨æˆ·å’Œç¤¾åŒºæ•°æ®
2. å‘é€ç™»å½•è¯·æ±‚
3. è·å–APIå“åº”æ•°æ®
4. é€å­—æ®µå¯¹æ¯”é¢„æœŸå¿«ç…§
5. éªŒè¯åŠ¨æ€å­—æ®µå­˜åœ¨æ€§
6. éªŒè¯æ•°æ®ç±»å‹æ­£ç¡®æ€§

**éªŒè¯ç‚¹**ï¼š
- âœ… å­—æ®µå®Œæ•´æ€§ï¼šæ‰€æœ‰é¢„æœŸå­—æ®µéƒ½å­˜åœ¨
- âœ… æ•°å€¼å‡†ç¡®æ€§ï¼šå­—æ®µå€¼ä¸æ•°æ®åº“æ•°æ®ä¸€è‡´
- âœ… ç±»å‹æ­£ç¡®æ€§ï¼šå­—æ®µç±»å‹ç¬¦åˆé¢„æœŸ
- âœ… åŠ¨æ€å­—æ®µï¼štokenå’Œrefresh_tokenå­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®

### 2. é”™è¯¯åœºæ™¯æµ‹è¯• (`test_login_phone_error_cases_data_consistency`)

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯å„ç§é”™è¯¯æƒ…å†µä¸‹çš„å“åº”æ•°æ®æ ¼å¼ä¸€è‡´æ€§

**æµ‹è¯•åœºæ™¯**ï¼š
- é”™è¯¯éªŒè¯ç ï¼ˆ999999ï¼‰
- é”™è¯¯å¯†ç 
- ç¼ºå°‘å¿…éœ€å‚æ•°
- ç”¨æˆ·ä¸å­˜åœ¨

**éªŒè¯ç‚¹**ï¼š
- âœ… é”™è¯¯ä»£ç æ­£ç¡®ï¼ˆ`code: 0`ï¼‰
- âœ… é”™è¯¯æ¶ˆæ¯åŒ…å«é¢„æœŸå…³é”®è¯
- âœ… é”™è¯¯æ•°æ®ç»“æ„ä¸€è‡´
- âœ… é”™è¯¯ä»£ç å­—æ®µç±»å‹æ­£ç¡®

### 3. æ€§èƒ½ä¸€è‡´æ€§æµ‹è¯• (`test_login_phone_performance_consistency`)

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯å¤šæ¬¡è¯·æ±‚çš„å“åº”ç¨³å®šæ€§

**æµ‹è¯•æ­¥éª¤**ï¼š
1. è¿ç»­å‘é€3æ¬¡ç™»å½•è¯·æ±‚
2. å¯¹æ¯”æ‰€æœ‰å“åº”çš„å…³é”®å­—æ®µ
3. éªŒè¯tokenç”Ÿæˆæœºåˆ¶

**éªŒè¯ç‚¹**ï¼š
- âœ… é™æ€å­—æ®µåœ¨å¤šæ¬¡è¯·æ±‚ä¸­ä¿æŒä¸€è‡´
- âœ… Tokenæ ¼å¼æ­£ç¡®ä¸”é•¿åº¦åˆç†
- âœ… Refresh Tokenæ ¼å¼æ­£ç¡®
- âš ï¸ Tokenå”¯ä¸€æ€§ï¼ˆè€ƒè™‘æ—¶é—´æˆ³ç²¾åº¦ï¼‰

### 4. æ•°æ®ç±»å‹æµ‹è¯• (`test_login_phone_data_type_consistency`)

**æµ‹è¯•ç›®æ ‡**ï¼šç¡®ä¿æ‰€æœ‰è¿”å›å­—æ®µçš„æ•°æ®ç±»å‹æ­£ç¡®

**ç±»å‹æ˜ å°„**
```python
expected_types = {
    'user_id': int,
    'wechat_openid': str,
    'phone_number': str,
    'nickname': str,
    'name': str,
    'avatar_url': (type(None), str),  # å…è®¸Noneæˆ–å­—ç¬¦ä¸²
    'role': str,
    'community_id': int,
    'community_name': str,
    'login_type': str,
    'token': str,
    'refresh_token': str
}
```

### 5. ä¸šåŠ¡é€»è¾‘æµ‹è¯• (`test_login_phone_business_logic_consistency`)

**æµ‹è¯•ç›®æ ‡**ï¼šéªŒè¯å…³é”®ä¸šåŠ¡é€»è¾‘çš„æ­£ç¡®æ€§

**éªŒè¯ç‚¹**ï¼š
- âœ… ç”¨æˆ·IDæ˜ å°„æ­£ç¡®
- âœ… è§’è‰²åç§°æ˜ å°„æ­£ç¡®ï¼ˆrole â†’ role_nameï¼‰
- âœ… ç¤¾åŒºå…³è”æ­£ç¡®
- âœ… ç™»å½•ç±»å‹è¯†åˆ«æ­£ç¡®
- âœ… æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯å­—æ®µåŒ¹é…

## æŠ€æœ¯å®ç°ç»†èŠ‚

### æµ‹è¯•æ•°æ®ç®¡ç†

#### ç”¨æˆ·åˆ›å»ºç­–ç•¥
```python
# å…³é”®ï¼šæ­£ç¡®è®¾ç½®phone_hashä»¥åŒ¹é…UserServiceæŸ¥è¯¢é€»è¾‘
phone_secret = os.getenv('PHONE_ENC_SECRET', 'default_secret')
phone_hash = sha256(f"{phone_secret}:{phone_number}".encode('utf-8')).hexdigest()

test_user = User(
    phone_number=phone_number,
    phone_hash=phone_hash,  # å…³é”®å­—æ®µ
    # ... å…¶ä»–å­—æ®µ
)
```

#### ç¯å¢ƒå˜é‡é…ç½®
```python
os.environ['ENV_TYPE'] = 'unit'  # ä½¿ç”¨å•å…ƒæµ‹è¯•ç¯å¢ƒ
os.environ['TOKEN_SECRET'] = 'test_token_secret_for_testing'  # é¿å…tokenç”Ÿæˆé”™è¯¯
```

### å¿«ç…§å¯¹æ¯”ç®—æ³•

#### å­—æ®µçº§å¯¹æ¯”
```python
for key, expected_value in expected_values.items():
    if key not in response_data:
        mismatches.append(f"âŒ ç¼ºå°‘å­—æ®µ: {key}")
    elif response_data[key] != expected_value:
        mismatches.append(f"âŒ å­—æ®µ {key} ä¸åŒ¹é…: æœŸæœ› '{expected_value}', å®é™… '{response_data[key]}'")
    else:
        matched_fields.append(f"âœ… {key}")
```

#### ç±»å‹éªŒè¯
```python
if not isinstance(response_data[field], expected_type):
    type_mismatches.append(f"âŒ å­—æ®µ {field} ç±»å‹é”™è¯¯: æœŸæœ› {expected_type}, å®é™… {type(response_data[field])}")
```

## æµ‹è¯•ç»“æœ

### æˆåŠŸæŒ‡æ ‡
- âœ… **5ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡**
- âœ… **æ•°æ®ä¸€è‡´æ€§ï¼š100%**
- âœ… **å­—æ®µè¦†ç›–ï¼š11ä¸ªé™æ€å­—æ®µ + 2ä¸ªåŠ¨æ€å­—æ®µ**
- âœ… **åœºæ™¯è¦†ç›–ï¼šæˆåŠŸã€é”™è¯¯ã€æ€§èƒ½ã€ç±»å‹ã€ä¸šåŠ¡é€»è¾‘**

### æµ‹è¯•è¾“å‡ºç¤ºä¾‹
```
âœ… åˆ›å»ºæµ‹è¯•ç”¨æˆ·: user_id=1
âœ… phone_number: 13900007997
âœ… phone_hash: 83af56cf0ad36505d633...
âœ… community_id: 1
âœ… é¢„æœŸå¿«ç…§å­—æ®µæ•°é‡: 10

ğŸ“± ç™»å½•å“åº”çŠ¶æ€ç : 200
ğŸ“‹ å®Œæ•´å“åº”æ•°æ®: {
  "token": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9...",
  "refresh_token": "Y92hJNTx2gBH13pqtDj5Wpw80sLfvCF83_PiLOU3FuY",
  "user_id": 1,
  "wechat_openid": "test_snapshot_success_user",
  "phone_number": "13900007997",
  "nickname": "æµ‹è¯•ç”¨æˆ·",
  "name": "æµ‹è¯•ç”¨æˆ·",
  "avatar_url": null,
  "role": "æ™®é€šç”¨æˆ·",
  "community_id": 1,
  "community_name": "æµ‹è¯•ç¤¾åŒº",
  "login_type": "existing_user"
}

ğŸ“Š å¿«ç…§å¯¹æ¯”ç»“æœ:
âœ… åŒ¹é…å­—æ®µ (13): âœ… user_id, âœ… wechat_openid, âœ… phone_number, âœ… nickname, âœ… name, âœ… avatar_url, âœ… role, âœ… community_id, âœ… community_name, âœ… login_type, âœ… token (å­˜åœ¨), âœ… refresh_token (å­˜åœ¨)

ğŸ‰ å¿«ç…§å¯¹æ¯”æµ‹è¯•å®Œå…¨é€šè¿‡ï¼
ğŸ“ˆ æ•°æ®ä¸€è‡´æ€§: 100% (13/13 å­—æ®µåŒ¹é…)
âœ… å…³é”®ä¸šåŠ¡é€»è¾‘éªŒè¯é€šè¿‡
```

## é›†æˆä¸éƒ¨ç½²

### è¿è¡Œæ–¹å¼
```bash
# ä½¿ç”¨pytestç›´æ¥è¿è¡Œ
python -m pytest tests/integration/test_auth_login_phone_snapshot_success.py -v

# ä½¿ç”¨é¡¹ç›®Makefileè¿è¡Œ
make its TEST=tests/integration/test_auth_login_phone_snapshot_success.py

# è¿è¡Œæ‰€æœ‰é›†æˆæµ‹è¯•
make it
```

### CI/CDé›†æˆ
- æµ‹è¯•åŒ…å«åœ¨é¡¹ç›®çš„æŒç»­é›†æˆæµç¨‹ä¸­
- æ”¯æŒå¹¶è¡Œæ‰§è¡Œä»¥æé«˜æ•ˆç‡
- å¤±è´¥æ—¶æä¾›è¯¦ç»†çš„å¯¹æ¯”æŠ¥å‘Š

## ç»´æŠ¤æŒ‡å—

### å¿«ç…§æ›´æ–°
å½“APIå“åº”ç»“æ„å‘ç”Ÿå˜åŒ–æ—¶ï¼š
1. æ›´æ–° `expected_values` å­—å…¸
2. è¿è¡Œæµ‹è¯•éªŒè¯é€šè¿‡
3. æ›´æ–°æœ¬æ–‡æ¡£

### æ–°å¢æµ‹è¯•åœºæ™¯
1. åœ¨æµ‹è¯•ç±»ä¸­æ·»åŠ æ–°çš„æµ‹è¯•æ–¹æ³•
2. éµå¾ªå‘½åè§„èŒƒï¼š`test_login_phone_<scenario>`
3. ç¡®ä¿æµ‹è¯•ç‹¬ç«‹æ€§å’Œå¯é‡å¤æ€§

### å¸¸è§é—®é¢˜æ’æŸ¥
- **phone_hashä¸åŒ¹é…**ï¼šç¡®ä¿ä½¿ç”¨ä¸UserServiceç›¸åŒçš„å“ˆå¸Œç®—æ³•
- **ç¯å¢ƒå˜é‡ç¼ºå¤±**ï¼šæ£€æŸ¥TOKEN_SECRETç­‰å¿…éœ€ç¯å¢ƒå˜é‡
- **SQLAlchemy Sessioné—®é¢˜**ï¼šåœ¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸­æ“ä½œæ•°æ®åº“

## æ€»ç»“

æœ¬å¿«ç…§å¯¹æ¯”é›†æˆæµ‹è¯•æˆåŠŸå®ç°äº†å¯¹ `/api/auth/login_phone` ç«¯ç‚¹çš„å…¨é¢æ•°æ®ä¸€è‡´æ€§éªŒè¯ã€‚é€šè¿‡é¢„å®šä¹‰å¿«ç…§ä¸å®é™…APIå“åº”çš„æ·±åº¦å¯¹æ¯”ï¼Œç¡®ä¿äº†ï¼š

1. **æ•°æ®å‡†ç¡®æ€§**ï¼šæ‰€æœ‰å­—æ®µéƒ½ä¸æ•°æ®åº“æ•°æ®ä¸€è‡´
2. **å“åº”ç¨³å®šæ€§**ï¼šå¤šæ¬¡è¯·æ±‚è¿”å›ä¸€è‡´çš„æ•°æ®ç»“æ„
3. **é”™è¯¯å¤„ç†è§„èŒƒ**ï¼šé”™è¯¯åœºæ™¯ä¸‹å“åº”æ ¼å¼ç»Ÿä¸€
4. **å›å½’æµ‹è¯•æ•ˆç‡**ï¼šå¿«ç…§æœºåˆ¶å®ç°å¿«é€ŸéªŒè¯

è¯¥æµ‹è¯•å¥—ä»¶ä¸ºAPIè´¨é‡ä¿è¯æä¾›äº†å¼ºæœ‰åŠ›çš„æ”¯æŒï¼Œç‰¹åˆ«é€‚åˆåœ¨æŒç»­é›†æˆç¯å¢ƒä¸­è¿›è¡Œè‡ªåŠ¨åŒ–éªŒè¯ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-12-24  
**æµ‹è¯•æ–‡ä»¶**: `tests/integration/test_auth_login_phone_snapshot_success.py`  
**æµ‹è¯•æ¡†æ¶**: pytest + Flask-TestClient  
**æµ‹è¯•ç¯å¢ƒ**: SQLiteå†…å­˜æ•°æ®åº“ï¼ˆunitç¯å¢ƒï¼‰