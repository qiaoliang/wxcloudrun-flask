# 环境变量简化设计方案

## 1. 背景和问题

当前项目中存在环境变量过多的问题，有多个环境配置文件和控制环境行为的变量，包括：
- 多个环境变量（ENV_TYPE、USE_SQLITE_FOR_TESTING、FLASK_ENV）控制环境类型
- 多个环境配置文件（.env、.env.unit、.env.function）
- 配置分散，难以管理

## 2. 目标

设计一个简化的环境变量管理方案，使用单一的 `ENV_TYPE` 环境变量来管理三种环境：
- unit：用于单元测试，使用SQLite内存数据库，不启动Flask服务，模拟所有外部API
- function：用于功能测试，使用SQLite 文件数据库，启动Flask服务，可能模拟部分外部服务
- prod：用于生产环境，使用SQLite 文件数据库，启动Flask服务，使用真实外部服务

## 3. 设计方案

### 3.1 核心环境变量
- `ENV_TYPE`：统一的环境类型标识，值为 unit/function/prod
- 其他配置（数据库地址、用户名、密码、外部服务API密钥等）通过环境配置文件管理

### 3.2 配置文件结构
- `.env.unit`：单元测试环境配置
  - 使用SQLite内存数据库
  - 所有外部服务API使用模拟实现
  - 不启动Flask Web服务
- `.env.function`：功能测试环境配置
  - 使用SQLite 文件数据库
  - 启动Flask Web服务
  - 可能模拟部分外部服务
- `.env.prod`：生产环境配置
  - 使用SQLite 文件数据库
  - 启动Flask Web服务
  - 使用真实外部服务API

### 3.3 外部服务抽象层
- 扩展现有的工厂模式，为每种外部服务创建抽象接口
- 实现真实版本和模拟版本
- 根据 `ENV_TYPE` 自动选择相应实现

### 3.4 数据库配置逻辑
- 在配置模块中根据 `ENV_TYPE` 自动选择数据库连接
- unit环境：固定使用SQLite内存数据库
- function/prod环境：根据各自配置使用SQLite 文件数据库

### 3.5 服务启动控制
- unit环境：仅运行测试，不启动Flask服务
- function/prod环境：启动Flask服务

## 4. 实现要点

### 4.1 配置管理器
创建 `config_manager.py` 来统一管理基于 `ENV_TYPE` 的配置加载逻辑

### 4.2 依赖注入与工厂模式
扩展现有的工厂模式到所有外部服务（微信API、Redis、短信服务、地图服务等）

### 4.3 启动逻辑
在 `run.py` 中根据 `ENV_TYPE` 决定是否启动Flask Web服务

## 5. 优势

- 简化环境变量管理，减少冗余
- 提高可维护性，易于理解
- 支持不同环境间的配置差异化
- 保持对所有外部服务的模拟能力
- 确保单元测试的隔离性和可靠性
