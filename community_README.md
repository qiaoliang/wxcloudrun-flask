# CommunityService 业务逻辑规则总结

## 概述

`CommunityService` 是处理社区相关核心业务逻辑的服务类，负责社区管理、用户管理、工作人员管理等功能的实现。

## 核心业务规则

### 1. 社区创建规则

- 社区名称必须唯一，不能重复
- 创建社区时自动设置主管：优先使用指定的 `manager_id`，否则创建者自动成为主管
- 创建社区时记录审计日志，包含创建者和主管信息

### 2. 社区工作人员管理规则

#### 角色体系
- `manager`：主管（每个社区只能有一个）
- `staff`：专员（可以有多个，或者没有）

#### 添加工作人员规则
- 主管只能添加一个，如果社区已有主管则不能再添加
- 用户不能在同一社区重复任职(绝对不能既是主管，也是专员)
- 添加失败时返回详细的失败原因列表

#### 移除工作人员规则
- 不能移除唯一的主管
- 移除时记录审计日志

### 3. 社区用户管理规则

#### 添加用户规则
- 批量添加用户到社区
- 检查用户是否已存在
- 检查用户是否已在社区中
- 返回添加成功和失败的详细信息

#### 移除用户规则（特殊社区逻辑）
- **从"安卡大家庭"移除**：用户自动移入"黑屋"
- **从普通社区移除**：
  - 如果除当前普通社区外，用户已不属于任何其他普通社区，则将该用户自动移入"安卡大家庭"
  - 如果用户已属于其他社区，仅从当前社区移除
- **从"黑屋"移除**：仅移除，不进行特殊处理

### 4. 社区状态管理规则

#### 社区状态
- `1`：启用状态
- `2`：停用状态

#### 状态切换规则
- 特殊社区（"安卡大家庭"、"黑屋"）不能停用
- 可以在启用和停用状态之间切换

### 5. 社区删除规则

- 特殊社区（"安卡大家庭"、"黑屋"）不能删除
- 社区必须先停用才能删除
- 社区内有用户时，不能删除该社区

### 6. 社区申请处理规则

#### 申请状态
- `1`：待审核
- `2`：已批准
- `3`：已拒绝

#### 处理规则
- 批准申请：将用户加入社区，记录审计日志
- 拒绝申请：必须提供拒绝理由，记录审计日志
- 只能处理待审核状态的申请

### 7. 用户搜索规则

#### 搜索方式
- 按昵称模糊搜索
- 按手机号精确搜索（使用哈希值匹配）
- 搜索结果限制为20条

#### 搜索社区用户
- 排除社区管理员
- 支持分页

### 8. 特殊社区规则

#### "安卡大家庭"（默认社区）
- 用户注册时默认加入
- 不能删除
- 不能停用
- 从普通社区移除且无其他社区时自动加入

#### "黑屋"
- 不能删除
- 不能停用
- 从"安卡大家庭"移除时自动加入

### 9. 数据一致性规则

- 所有数据库操作使用事务
- 操作失败时回滚事务
- 关键操作记录审计日志
- 使用会话管理避免数据冲突

### 10. 错误处理规则

- 业务逻辑错误抛出 `ValueError`
- 返回明确的错误信息
- 批量操作时返回详细的成功/失败信息

## 使用示例

```python
# 创建社区
community = CommunityService.create_community(
    name="测试社区",
    description="测试描述",
    creator_id=user_id,
    location="测试地点"
)

# 添加工作人员
result = CommunityService.add_community_staff(
    community_id=community_id,
    user_ids=[user_id1, user_id2],
    role='staff'
)

# 移除用户（自动处理特殊社区逻辑）
result = CommunityService.remove_user_from_community(
    community_id=community_id,
    user_id=user_id
)
# result['moved_to'] 可能是 '黑屋'、'安卡大家庭' 或 None
```

## 注意事项

1. 所有方法都是静态方法，直接通过类名调用
2. 数据库操作使用 `get_db().get_session()` 确保会话隔离
3. 特殊社区逻辑是系统的核心特性，需要特别注意
4. 审计日志记录了所有关键操作，便于追踪和调试